{% assign collection = collections[block.settings.collection] %}
{% assign bundle_rules_metafield = shop.metafields.bundle_app.rules.value %}
{% assign app_url = bundle_rules_metafield.appUrl | default: "/apps/bundle-app" %}

{% style %}
/* Reset & Base Styles */
.bundle-wrapper{max-width:1200px;margin:0 auto;padding:20px 16px 140px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;position:relative}

/* Header Section */
.bundle-header{text-align:center;margin-bottom:30px}
.bundle-title{font-size:28px;font-weight:700;margin-bottom:12px;color:#1a202c}
.bundle-description{font-size:16px;color:#718096;margin-bottom:24px;line-height:1.5}

/* Bundle Discount Badges - Horizontal Layout */
.bundle-rules-container{margin-bottom:30px}
.bundle-rules{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;padding:0 4px}

.bundle-rule-badge{
  background:#fff;
  border:2px solid #e2e8f0;
  border-radius:12px;
  padding:8px 20px;
  font-size:14px;
  font-weight:700;
  color:#2d3748;
  transition:all .2s ease;
  cursor:default;
  white-space:nowrap;
  min-width:120px;
  text-align:center;
}

.bundle-rule-badge.active{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  border-color:#667eea;
  transform:scale(1.05);
  box-shadow:0 4px 12px rgba(102,126,234,.3);
}

/* Product Grid */
.products-section-header{font-size:22px;font-weight:700;color:#2d3748;margin-bottom:20px;text-align:center}
.bundle-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;margin-top:20px}

/* Product Card */
.bundle-product{
  border:1.5px solid #e2e8f0;
  border-radius:12px;
  padding:16px;
  text-align:center;
  background:#fff;
  transition:all .3s ease;
  position:relative;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  height:100%;
  cursor:pointer;
}

.bundle-product:hover{
  transform:translateY(-3px);
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  border-color:#667eea;
}

.out-of-stock-overlay{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,.9);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1;
  border-radius:12px;
}

.out-of-stock-text{
  background:#fed7d7;
  color:#742a2a;
  padding:8px 16px;
  border-radius:8px;
  font-weight:700;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.5px;
}

.product-image-container{
  width:100%;
  height:200px;
  overflow:hidden;
  border-radius:8px;
  margin-bottom:16px;
  background:#f7fafc;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

.product-image{
  width:100%;
  height:100%;
  object-fit:contain;
  transition:transform .3s ease;
}

.bundle-product:hover .product-image{transform:scale(1.05)}

.product-title{
  font-size:16px;
  font-weight:700;
  color:#2d3748;
  margin-bottom:12px;
  line-height:1.4;
  flex:1;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  min-height:44px;
}

.price-container{margin-bottom:16px}
.price-wrapper{display:flex;align-items:baseline;justify-content:center;gap:8px;flex-wrap:wrap}
.price-original{font-size:17px;font-weight:800;color:#2d3748}
.price-original.cut{text-decoration:line-through;color:#a0aec0;font-size:15px;font-weight:600}
.price-discounted{font-size:22px;font-weight:900;color:#16a34a}

/* Modal Styles */
.bundle-modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.8);
  backdrop-filter:blur(8px);
  z-index:999999;
  display:none;
  align-items:center;
  justify-content:center;
  padding:20px;
  animation:fadeIn 0.3s ease;
}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.bundle-modal{
  width:100%;
  max-width:1000px;
  max-height:90vh;
  background:#fff;
  border-radius:24px;
  overflow:hidden;
  box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
  position:relative;
  animation:slideUp 0.4s cubic-bezier(0.165,0.84,0.44,1);
  display:flex;
  flex-direction:column;
}

@keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}

.bundle-modal-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:20px 24px;
  border-bottom:1px solid #f1f5f9;
  background:#fff;
}

.bundle-modal-title{
  font-size:20px;
  font-weight:800;
  color:#0f172a;
  flex:1;
}

.bundle-modal-close{
  border:none;
  cursor:pointer;
  font-size:18px;
  width:36px;
  height:36px;
  border-radius:10px;
  background:#f8fafc;
  color:#64748b;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.2s ease;
}

.bundle-modal-close:hover{
  background:#f1f5f9;
  color:#0f172a;
  transform:rotate(90deg);
}

.bundle-modal-body{
  display:grid;
  grid-template-columns:450px 1fr;
  gap:32px;
  padding:24px;
  overflow-y:auto;
  flex:1;
}

/* Image Gallery Section */
.modal-image-section{display:flex;flex-direction:column;gap:16px}

.modal-main-image{
  border-radius:20px;
  border:1px solid #f1f5f9;
  background:#f8fafc;
  height:400px;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:24px;
  position:relative;
}

.modal-main-image img{
  width:100%;
  height:100%;
  object-fit:contain;
  transition:transform 0.3s ease;
}

/* Carousel Styles */
.modal-carousel-container{
  position:relative;
  width:100%;
  overflow:hidden;
  padding:0 40px;
}

.modal-carousel-wrapper{
  width:100%;
  overflow:hidden;
  position:relative;
}

.modal-carousel{
  display:flex;
  gap:12px;
  transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  width:max-content;
}

.modal-thumbnail{
  flex:0 0 auto;
  width:80px;
  height:80px;
  border-radius:12px;
  border:2px solid #e2e8f0;
  background:#fff;
  overflow:hidden;
  cursor:pointer;
  transition:all 0.2s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:8px;
}

.modal-thumbnail:hover{
  border-color:#667eea;
  transform:scale(1.05);
}

.modal-thumbnail.active{
  border-color:#667eea;
  box-shadow:0 0 0 3px rgba(102,126,234,.2);
}

.modal-thumbnail.out-of-stock{
  opacity:0.4;
  cursor:not-allowed;
}

.modal-thumbnail img{
  width:100%;
  height:100%;
  object-fit:contain;
}

.carousel-btn{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:32px;
  height:32px;
  border-radius:50%;
  background:rgba(255,255,255,0.95);
  border:1px solid #e2e8f0;
  color:#2d3748;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:10;
  transition:all 0.2s ease;
  font-weight:bold;
  font-size:16px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

.carousel-btn:hover:not(:disabled){
  background:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  border-color:#667eea;
  color:#667eea;
}

.carousel-btn.prev{
  left:8px;
}

.carousel-btn.next{
  right:8px;
}

.carousel-btn:disabled{
  opacity:0.3;
  cursor:not-allowed;
  background:rgba(255,255,255,0.7);
}

/* Product Info Section */
.modal-info{display:flex;flex-direction:column;gap:20px}
.modal-info h3{font-size:26px;font-weight:800;color:#0f172a;line-height:1.2;margin:0}

.modal-price-container{padding-bottom:16px;border-bottom:1px solid #f1f5f9}
.modal-price{font-size:30px;font-weight:800;color:#059669;display:flex;align-items:center;gap:12px}
.modal-price-original{font-size:20px;color:#94a3b8;text-decoration:line-through;font-weight:500}

.modal-discount-badge{
  background:linear-gradient(135deg,#48bb78,#38a169);
  color:#fff;
  padding:6px 12px;
  border-radius:8px;
  font-size:12px;
  font-weight:700;
  display:inline-block;
  margin-top:8px;
}

.modal-inventory-info{
  font-size:13px;
  font-weight:700;
  padding:8px 12px;
  border-radius:8px;
  display:inline-flex;
  align-items:center;
  gap:6px;
  width:fit-content;
}

.modal-inventory-info.in-stock{background:#ecfdf5;color:#059669}
.modal-inventory-info.low-stock{background:#fffbeb;color:#d97706}
.modal-inventory-info.out-of-stock{background:#fef2f2;color:#dc2626}

/* Variant Selection as Boxes */
.modal-variants-section{display:flex;flex-direction:column;gap:12px}
.modal-variants-label{
  font-size:12px;
  font-weight:700;
  color:#64748b;
  text-transform:uppercase;
  letter-spacing:0.05em;
}

.modal-variant-boxes{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  max-width:450px;
}

.modal-variant-box{
  padding:10px 16px;
  border:2px solid #e2e8f0;
  border-radius:10px;
  background:#fff;
  text-align:center;
  cursor:pointer;
  transition:all 0.2s ease;
  font-weight:600;
  color:#2d3748;
  font-size:13px;
  white-space:nowrap;
  flex:0 0 auto;
}

.modal-variant-box:hover:not(.out-of-stock){
  border-color:#6366f1;
  background:#f5f3ff;
  color:#6366f1;
}

.modal-variant-box.active{
  border-color:#667eea;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;
  box-shadow:0 4px 8px rgba(102,126,234,.3);
}

.modal-variant-box.out-of-stock{
  opacity:0.4;
  cursor:not-allowed;
  background:#f8fafc;
}

/* Modal Footer with Quantity and Add Button */
.bundle-modal-footer{
  padding:20px 24px;
  border-top:1px solid #f1f5f9;
  background:#fff;
  display:flex;
  align-items:center;
  gap:20px;
}

.modal-qty-section{
  display:flex;
  align-items:center;
  gap:12px;
  flex:0 0 auto;
}

.modal-qty-label{
  font-size:14px;
  font-weight:700;
  color:#334155;
  white-space:nowrap;
}

.modal-qty-controls{
  display:flex;
  align-items:center;
  gap:8px;
  background:#f8fafc;
  border:1px solid #e2e8f0;
  border-radius:12px;
  padding:4px;
}

.modal-qty-btn{
  width:36px;
  height:36px;
  border-radius:8px;
  border:1px solid #e2e8f0;
  background:#fff;
  color:#0f172a;
  font-weight:800;
  font-size:16px;
  cursor:pointer;
  transition:all 0.2s ease;
  display:flex;
  align-items:center;
  justify-content:center;
}

.modal-qty-btn:hover:not(:disabled){
  border-color:#6366f1;
  color:#6366f1;
  background:#f5f3ff;
}

.modal-qty-btn:disabled{
  opacity:0.4;
  cursor:not-allowed;
  background:#f1f5f9;
}

.modal-qty-input{
  width:50px;
  text-align:center;
  font-weight:700;
  font-size:16px;
  border:none;
  background:transparent;
  color:#0f172a;
  outline:none;
}

.modal-add-btn{
  flex:1;
  height:56px;
  border-radius:16px;
  border:none;
  cursor:pointer;
  font-weight:800;
  color:#fff;
  background:linear-gradient(135deg,#6366f1,#8b5cf6);
  font-size:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  transition:all 0.3s ease;
  padding:0 24px;
}

.modal-add-btn:hover:not(:disabled){
  transform:translateY(-2px);
  box-shadow:0 10px 25px -5px rgba(99,102,241,0.4);
}

.modal-add-btn:disabled{
  background:#e2e8f0;
  color:#94a3b8;
  cursor:not-allowed;
}

/* Bottom Bar */
.fixed-bottom-bar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  z-index:9998;
  background:rgba(255,255,255,0.98);
  backdrop-filter:blur(10px);
  box-shadow:0 -4px 20px rgba(0,0,0,0.1);
  border-top:1px solid rgba(0,0,0,0.08);
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  padding-bottom:env(safe-area-inset-bottom);
  transform:translateY(100%);
}

.fixed-bottom-bar.visible{
  transform:translateY(0);
}

.bottom-bar-content{
  max-width:1200px;
  margin:0 auto;
  padding:10px 20px;
}

.bottom-bar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
}

.bottom-bar-left{
  display:flex;
  align-items:center;
  gap:12px;
  flex:1;
}

.bottom-bar-icon{
  width:40px;
  height:40px;
  border-radius:50%;
  background:linear-gradient(135deg,#667eea,#764ba2);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:18px;
  flex-shrink:0;
}

.bottom-bar-info{flex:1;min-width:0}
.bottom-bar-title{font-size:16px;font-weight:700;color:#2d3748;margin-bottom:4px}
.bottom-bar-subtitle{font-size:13px;color:#718096}
.bottom-bar-subtitle.discount-active{color:#16a34a;font-weight:600}

.review-close-btn{
  position: absolute;
  top: 12px;
  right: 16px;
  width: 28px;
  height: 28px;
  background: #f1f5f9;
  border: none;
  border-radius: 50%;
  color: #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 20;
  font-size: 14px;
  transition: all 0.2s ease;
}

.review-close-btn:hover{
  background: #e2e8f0;
  color: #0f172a;
}


.bottom-bar-header{
  display:flex;
  align-items:center;
  gap:12px;
  width: 100%;
}

.discount-status-bar{
  text-align: center;
  font-size: 13px;
  font-weight: 700;
  color: #059669;
  background: #ecfdf5;
  padding: 6px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: none; /* Hidden by default */
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

.checkout-btn{
  width: 100%;
  height: 44px;
  background: #62BEBA;
  border:none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 800;
  color:#fff;
  cursor:pointer;
  transition:all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.btn-badge {
  position: absolute;
  left: 20px;
  background: rgba(255,255,255,0.2);
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 800;
  border: 1px solid rgba(255,255,255,0.4);
}

.checkout-btn:hover:not(:disabled){
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(98, 190, 186, 0.3);
  filter: brightness(1.05);
}

.checkout-btn:disabled{
  background:#cbd5e0;
  cursor:not-allowed;
  opacity:0.7;
}

/* Bundle Review Section */
.bundle-review-section{
  position:absolute;
  bottom:100%;
  left:0;
  right:0;
  background:#fff;
  max-height:0;
  overflow:hidden;
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border-top:1px solid rgba(0,0,0,0.08);
  box-shadow:0 -10px 30px rgba(0,0,0,0.08);
  z-index:10;
  border-radius:16px 16px 0 0;
}

.bundle-review-section.expanded{
  max-height:340px; /* Approximately 4 items + padding */
  padding:12px 0 0;
  overflow-y:auto;
  scrollbar-width:thin;
}

.bundle-review-section::-webkit-scrollbar{
  width:4px;
}

.bundle-review-section::-webkit-scrollbar-thumb{
  background:#cbd5e1;
  border-radius:10px;
}

.bundle-review-items{
  display:flex;
  flex-direction:column;
  gap:6px;
  padding:0 4px;
}

.bundle-review-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px 12px;
  background:#fff;
  border-radius:8px;
  border:1px solid #f1f5f9;
  transition:background 0.2s ease;
}

.bundle-review-item:hover{
  background:#f8fafc;
}

.bundle-review-thumb{
  width:50px;
  height:50px;
  border-radius:6px;
  background:#fff;
  border:1px solid #f1f5f9;
  overflow:hidden;
  flex-shrink:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:3px;
}

.bundle-review-thumb img{
  width:100%;
  height:100%;
  object-fit:contain;
}

.bundle-review-info{flex:1;min-width:0}
.bundle-review-title{font-size:13px;font-weight:700;color:#0f172a;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bundle-review-variant{font-size:11px;color:#64748b}
.bundle-review-price{font-size:13px;font-weight:700;color:#059669;margin-top:2px}
.bundle-review-price.original{color:#94a3b8;text-decoration:line-through;font-size:11px;font-weight:500}

.bundle-review-qty{
  display:flex;
  align-items:center;
  gap:6px;
  background:#f8fafc;
  border:1px solid #f1f5f9;
  border-radius:8px;
  padding:3px;
}

.qty-btn-small{
  width:24px;
  height:24px;
  border-radius:5px;
  border:1px solid #e2e8f0;
  background:#fff;
  color:#0f172a;
  font-weight:700;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.2s ease;
  font-size:14px;
}

.qty-btn-small:hover:not(:disabled){
  background:#edf2f7;
  transform:scale(1.1);
}

.qty-btn-small:disabled{
  opacity:0.4;
  cursor:not-allowed;
}

.qty-display{
  min-width:24px;
  text-align:center;
  font-weight:700;
  font-size:12px;
}

.remove-btn{
  padding:6px 10px;
  background:transparent;
  color:#ef4444;
  border:1px solid #fee2e2;
  border-radius:8px;
  font-size:11px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
  display:flex;
  align-items:center;
  gap:4px;
  white-space:nowrap;
}

.remove-btn:hover{
  background:#fef2f2;
}

/* Toast Notification */
.bundle-toast{
  position:fixed;
  top:16px;
  right:16px;
  z-index:999999;
  padding:12px 20px;
  border-radius:14px;
  background:#111827;
  color:#fff;
  font-size:14px;
  font-weight:600;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  opacity:0;
  transform:translateY(-12px);
  transition:all .28s ease;
  max-width:320px;
}

.bundle-toast.show{opacity:1;transform:translateY(0)}
.bundle-toast.success{background:linear-gradient(135deg,#16a34a,#15803d)}
.bundle-toast.error{background:linear-gradient(135deg,#dc2626,#b91c1c)}
.bundle-toast.warning{background:linear-gradient(135deg,#d97706,#b45309)}

/* Loader */
.bundle-loader-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.6);
  backdrop-filter:blur(4px);
  z-index:9999999;
  display:none;
  align-items:center;
  justify-content:center;
}

.bundle-loader-box{
  background:#fff;
  padding:32px;
  border-radius:24px;
  text-align:center;
  min-width:240px;
  box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);
}

.bundle-spinner{
  width:48px;
  height:48px;
  border:4px solid #f1f5f9;
  border-top-color:#6366f1;
  border-radius:50%;
  margin:0 auto 20px;
  animation:spin 1s ease infinite;
}

@keyframes spin{100%{transform:rotate(360deg)}}

/* Mobile Responsiveness */
@media screen and (max-width: 768px){
  .bundle-modal{
    max-height:92vh;
    border-radius:24px 24px 0 0;
  }
  
  .bundle-modal-body{
    grid-template-columns:1fr;
    gap:20px;
  }
  
  .modal-main-image{height:300px}
  
  .bundle-modal-footer{
    flex-direction:row;
    flex-wrap:wrap;
    gap:12px;
    padding:16px 20px;
  }
  
  .modal-qty-section{
    flex:1;
    min-width:140px;
    justify-content:center;
  }
  
  .modal-add-btn{
    flex:2;
    min-width:200px;
  }
  
  .bottom-bar-header{
    flex-direction:column;
    align-items:stretch;
    gap:8px;
  }
  
  .bottom-bar-left{
    flex-direction:row;
    align-items:center;
  }
  
  .bottom-bar-actions{
    width:100%;
  }
  
  .checkout-btn{
    width:100%;
    text-align:center;
  }
  
  .bundle-review-section.expanded{
    max-height:50vh;
  }
  
  .bundle-review-item{
    flex-direction:column;
    align-items:stretch;
    gap:8px;
  }
  
  .bundle-review-right{
    width:100%;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
}

@media screen and (max-width: 480px){
  .bundle-grid{
    grid-template-columns:1fr;
    gap:16px;
  }
  
  .bundle-rules{
    gap:8px;
  }
  
  .bundle-rule-badge{
    padding:6px 12px;
    font-size:12px;
    min-width:100px;
  }
  
  .modal-variant-box{
    padding:8px 12px;
    font-size:12px;
  }
  
  .modal-qty-section{
    flex-direction:column;
    align-items:stretch;
    gap:8px;
  }
  
  .modal-qty-controls{
    justify-content:center;
  }
}

body.modal-open{overflow:hidden}
{% endstyle %}

{% if collection %}
<div class="bundle-wrapper">
  <div class="bundle-header">
    <h1 class="bundle-title"># Share God's Word This Year!</h1>
    <p class="bundle-description">Choose your bracelets & discounts are automatically applied as you build your pack!</p>
  </div>

  <!-- Bundle Discount Badges -->
  <div class="bundle-rules-container">
    <div class="bundle-rules" id="bundleRules">
      <div class="bundle-rule-badge">Loading bundle rules...</div>
    </div>
  </div>

  <!-- Product Grid -->
  <div class="products-section">
    <h2 class="products-section-header">Select Your Items</h2>
    <div class="bundle-grid" id="productGrid">
      {% for product in collection.products limit: 24 %}
        {% assign first_variant = product.selected_or_first_available_variant %}
        <div class="bundle-product" data-product-id="{{ product.id }}" onclick="openProductModal({{ product.id }})">
          {% unless first_variant.available %}
            <div class="out-of-stock-overlay">
              <div class="out-of-stock-text">Out of Stock</div>
            </div>
          {% endunless %}
          
          <div class="product-image-container">
            {% if product.featured_image %}
              <img src="{{ product.featured_image | img_url: 'medium' }}" alt="{{ product.title }}" class="product-image">
            {% else %}
              <div style="color:#718096;font-size:12px">No Image</div>
            {% endif %}
          </div>
          
          <h3 class="product-title">{{ product.title }}</h3>
          
          <div class="price-container">
            <div class="price-wrapper">
              <span class="price-original" data-original-price="{{ product.price }}">{{ product.price | money }}</span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Product Data (Hidden) -->
  <div style="display:none" id="productData">
    {% for product in collection.products limit: 24 %}
      <div data-product="{{ product.id }}">
        <div data-title="{{ product.title }}"></div>
        <div data-price="{{ product.price }}"></div>
        <div data-available="{{ product.available }}"></div>
        <div data-image="{% if product.featured_image %}{{ product.featured_image | img_url: 'large' }}{% endif %}"></div>
        <div data-variants>
          {% for variant in product.variants %}
            <div data-variant-id="{{ variant.id }}"
                 data-variant-title="{{ variant.title }}"
                 data-variant-price="{{ variant.price }}"
                 data-variant-available="{{ variant.available }}"
                 data-variant-image="{% if variant.image %}{{ variant.image | img_url: 'large' }}{% else %}{{ product.featured_image | img_url: 'large' }}{% endif %}">
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Product Modal -->
<div class="bundle-modal-overlay" id="productModal">
  <div class="bundle-modal">
    <div class="bundle-modal-header">
      <h2 class="bundle-modal-title" id="modalTitle">Product Details</h2>
      <button class="bundle-modal-close" onclick="closeProductModal()">‚úï</button>
    </div>
    
    <div class="bundle-modal-body">
      <!-- Image Gallery -->
      <div class="modal-image-section">
        <div class="modal-main-image" id="modalMainImage">
          <img src="" alt="Product Image">
        </div>
        <div class="modal-carousel-container">
          <button class="carousel-btn prev" id="carouselPrev" onclick="moveCarousel(-1)">‚Äπ</button>
          <div class="modal-carousel-wrapper">
            <div class="modal-carousel" id="modalCarousel"></div>
          </div>
          <button class="carousel-btn next" id="carouselNext" onclick="moveCarousel(1)">‚Ä∫</button>
        </div>
      </div>
      
      <!-- Product Info -->
      <div class="modal-info">
        <h3 id="modalProductTitle"></h3>
        
        <div class="modal-price-container">
          <div id="modalPriceDisplay"></div>
        </div>
        
        <div class="modal-inventory-info in-stock" id="modalStock">
          <span>‚úì</span> In Stock
        </div>
        
        <!-- Variant Selection as Boxes -->
        <div class="modal-variants-section" id="modalVariantsSection">
          <div class="modal-variants-label">Select Variant</div>
          <div class="modal-variant-boxes" id="modalVariantBoxes"></div>
        </div>
      </div>
    </div>
    
    <!-- Modal Footer with Quantity and Add Button -->
    <div class="bundle-modal-footer">
      <div class="modal-qty-section">
        <div class="modal-qty-label">Quantity:</div>
        <div class="modal-qty-controls">
          <button class="modal-qty-btn" onclick="decreaseModalQty()">-</button>
          <input type="number" class="modal-qty-input" id="modalQtyInput" value="1" min="1" max="10">
          <button class="modal-qty-btn" onclick="increaseModalQty()">+</button>
        </div>
      </div>
      
      <button class="modal-add-btn" id="modalAddBtn" onclick="addToBundle()">
        üõí Add to Bundle
      </button>
    </div>
  </div>
</div>

<!-- Bottom Bar -->
<div class="fixed-bottom-bar" id="bottomBar">
  <!-- Review Section (Moves Above) -->
  <div class="bundle-review-section" id="reviewSection">
    <button class="review-close-btn" onclick="toggleReviewSection()">‚úï</button>
    <div class="bottom-bar-content">
      <div class="bundle-review-items" id="reviewItems"></div>
    </div>
  </div>

  <div class="bottom-bar-content">
    <div class="discount-status-bar" id="discountStatusBar"></div>
    <div class="bottom-bar-header" id="bottomBarHeader">
      <button class="checkout-btn" id="checkoutBtn" onclick="handleBottomBarAction()">
        <span class="btn-badge" id="btnCartBadge">0</span>
        <span id="checkoutBtnText">Review Your Pack</span>
      </button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="bundle-toast" id="bundleToast"></div>

<!-- Loader -->
<div class="bundle-loader-overlay" id="bundleLoader">
  <div class="bundle-loader-box">
    <div class="bundle-spinner"></div>
    <div id="loaderText">Processing...</div>
  </div>
</div>

<script>
// ==================== GLOBAL STATE ====================
let bundleState = {
  allBundles: [],
  allRules: [],
  activeBundle: null,
  activeRule: null,
  cartItems: 0,
  cart: null,
  cartProducts: {},
  currentDiscountCode: null,
  currentDiscountPercent: 0,
  productPrices: {},
  discountCodes: {},
  lastAppliedCode: null,
  isCreatingDiscount: false,
  isFetchingBundles: false,
  isApplyingDiscount: false,
  lastCartSignature: null,
  cartFetchInFlight: false,
  lastToastKey: null,
  // Modal state
  modal: {
    open: false,
    product: null,
    selectedVariantId: null,
    selectedVariant: null,
    carouselContainerWidth: 0,
    carouselPosition: 0,
    carouselVisibleCount: 0
  },
  // Your Pack state
  yourPackExpanded: false
};

// Cart items array
let bundleItems = [];

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  loadPersistentData();
  
  // Try to load bundles from metafield immediately
  const metafieldBundles = {{ shop.metafields.bundle_app.rules.value.bundles | json | default: '[]' }};
  if (metafieldBundles && metafieldBundles.length > 0) {
    bundleState.allBundles = metafieldBundles;
    processBundlesData(metafieldBundles);
  }
  
  // Initialize product prices
  document.querySelectorAll('.bundle-product').forEach(product => {
    const priceElement = product.querySelector('.price-original');
    if (priceElement) {
      const originalPrice = parseInt(priceElement.getAttribute('data-original-price'));
      bundleState.productPrices[product.dataset.productId] = { 
        original: originalPrice, 
        discounted: originalPrice 
      };
    }
  });
  
  // No manual event listener needed as we use onclick in HTML
  
  // Modal event listeners
  document.getElementById('modalQtyInput')?.addEventListener('input', handleModalQtyInput);
  document.getElementById('modalQtyInput')?.addEventListener('change', validateModalQty);
  document.getElementById('modalAddBtn')?.addEventListener('click', addToBundle);
  
  // Modal overlay click to close
  document.getElementById('productModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeProductModal();
    }
  });
  
  // Keyboard support
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && bundleState.modal.open) {
      closeProductModal();
    }
  });

  // Initialize bundles and cart
  (async function() {
    showLoader('Loading...');
    
    await fetchAllBundles();
    await updateCartData({ reason: 'init', force: true });
    hideLoader();
  })();
  
  // Refresh cart on focus
  window.addEventListener('focus', () => updateCartData({ reason: 'focus' }));
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) updateCartData({ reason: 'visibility' });
  });
  
  // Handle window resize for carousel
  window.addEventListener('resize', debounce(function() {
    if (bundleState.modal.open && bundleState.modal.product) {
      calculateCarouselVisibleCount();
      updateCarouselButtons();
    }
  }, 250));
});

// ==================== PERSISTENT STORAGE ====================
const STORAGE_KEY = 'bundle_discounts_v8';

function loadPersistentData() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return;

    const data = JSON.parse(saved);
    bundleState.discountCodes = data.discountCodes || {};
    bundleState.lastAppliedCode = data.lastAppliedCode || null;

    const now = Date.now();
    if (data.expiresAt && now > data.expiresAt) {
      bundleState.discountCodes = {};
      bundleState.lastAppliedCode = null;
      savePersistentData();
    }
  } catch (e) {
    console.error('Error loading persistent data:', e);
  }
}

function savePersistentData() {
  try {
    const data = {
      discountCodes: bundleState.discountCodes,
      lastAppliedCode: bundleState.lastAppliedCode,
      expiresAt: Date.now() + (24 * 60 * 60 * 1000)
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    console.error('Error saving persistent data:', e);
  }
}

function getSavedDiscountCode(bundleId, tierIndex) {
  const key = `${bundleId}_${tierIndex}`;
  return bundleState.discountCodes[key] || null;
}

function saveDiscountCode(bundleId, tierIndex, code) {
  const key = `${bundleId}_${tierIndex}`;
  bundleState.discountCodes[key] = code;
  savePersistentData();
}

// ==================== BUNDLE API FUNCTIONS ====================
async function fetchAllBundles() {
  try {
    const collectionId = document.querySelector('.bundle-wrapper')?.dataset?.collectionId;
    bundleState.isFetchingBundles = true;
    
    // Replace with your actual API endpoint
    const APP_URL = 'https://bundle-app-c4km.onrender.com';
    
    // Fetch in background to update any cached data
    const response = await fetch(`${APP_URL}/api/bundles`, {
      headers: {
        'Authorization': 'Bearer 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',
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const data = await response.json();
      if (data.success && Array.isArray(data.bundles)) {
        processBundlesData(data.bundles, collectionId);
        return;
      }
    }
    
    if (!bundleState.allBundles.length) {
      useFallbackBundleRules();
    }
  } catch (error) {
    console.error('Error fetching bundles:', error);
    if (!bundleState.allBundles.length) {
      useFallbackBundleRules();
    }
  } finally {
    bundleState.isFetchingBundles = false;
  }
}

function processBundlesData(bundles, collectionId) {
  let filteredBundles = bundles;
  if (collectionId) {
    filteredBundles = bundles.filter(b =>
      b.collectionId && b.collectionId.toString() === collectionId.toString()
    );
  }

  bundleState.allBundles = filteredBundles;
  
  if (bundleState.allBundles.length > 0) {
    bundleState.allBundles.forEach(bundle => {
      if (bundle.rules) {
        bundle.rules.forEach((rule, idx) => {
          const tierIndex = (rule.tierIndex ?? idx);
          rule.tierIndex = tierIndex;
          rule.discountCode = getSavedDiscountCode(bundle.id, tierIndex);
        });
      }
    });

    flattenAllRules();
    renderBundleRules();
    updateUI();
  }
}

function useFallbackBundleRules() {
  // Fallback to default rules if API fails
  bundleState.allBundles = [{
    id: 'default',
    rules: [
      { totalProducts: 3, discountPercentage: 20, tierIndex: 0 },
      { totalProducts: 5, discountPercentage: 25, tierIndex: 1 },
      { totalProducts: 10, discountPercentage: 30, tierIndex: 2 },
      { totalProducts: 20, discountPercentage: 40, tierIndex: 3 }
    ]
  }];
  
  flattenAllRules();
  renderBundleRules();
  updateUI();
}

function flattenAllRules() {
  bundleState.allRules = [];

  bundleState.allBundles.forEach(bundle => {
    if (bundle.rules && bundle.rules.length > 0) {
      bundle.rules.forEach(rule => {
        bundleState.allRules.push({
          ...rule,
          bundleId: bundle.id,
          totalProducts: Number(rule.totalProducts || 0),
          discountPercentage: Number(rule.discountPercentage || 0),
          tierIndex: rule.tierIndex ?? 0,
          discountCode: rule.discountCode || null
        });
      });
    }
  });

  bundleState.allRules.sort((a, b) => a.totalProducts - b.totalProducts);
}

function findBestMatchingRule() {
  if (bundleState.allRules.length === 0) return null;
  for (let i = bundleState.allRules.length - 1; i >= 0; i--) {
    const rule = bundleState.allRules[i];
    if (bundleState.cartItems >= rule.totalProducts) return rule;
  }
  return null;
}

// ==================== RENDER BUNDLE RULES ====================
function renderBundleRules() {
  const container = document.getElementById('bundleRules');
  if (!container) return;

  if (bundleState.allRules.length === 0) {
    container.innerHTML = '<div class="bundle-rule-badge">No bundle rules available</div>';
    return;
  }

  const totalItems = bundleState.cartItems;
  
  container.innerHTML = bundleState.allRules.map((rule, idx) => {
    const isActive = totalItems >= rule.totalProducts;
    const discountText = rule.discountPercentage ? `${rule.discountPercentage}% Off` : 'Discount';
    return `
      <div class="bundle-rule-badge ${isActive ? 'active' : ''}" title="${rule.totalProducts}+ items - ${discountText}">
        ${rule.totalProducts} Pack ¬∑ ${discountText}
      </div>
    `;
  }).join('');
}

// ==================== CART FUNCTIONS ====================
async function updateCartData({ reason, force } = {}) {
  try {
    if (bundleState.cartFetchInFlight) return;
    bundleState.cartFetchInFlight = true;

    const response = await fetch('/cart.js', { cache: 'no-store' });
    const cart = await response.json();

    bundleState.cart = cart;
    bundleState.cartProducts = {};
    if (Array.isArray(cart.items)) {
      cart.items.forEach(item => {
        bundleState.cartProducts[item.variant_id] = {
          quantity: item.quantity,
          key: item.key,
          product_id: item.product_id,
          variant_id: item.variant_id,
          available: true
        };
      });
    }

    bundleState.cartItems = cart.items.reduce((total, item) => total + item.quantity, 0);

    // Update bundle items array from cart
    bundleItems = cart.items.map(item => ({
      productId: item.product_id,
      variantId: item.variant_id,
      title: item.product_title,
      variantTitle: item.variant_title,
      price: item.price,
      image: item.image,
      quantity: item.quantity,
      key: item.key,
      linePrice: item.line_price,
      originalLinePrice: item.original_line_price
    }));

    const bestRule = findBestMatchingRule();
    if (bestRule) {
      bundleState.activeRule = bestRule;
      bundleState.currentDiscountPercent = bestRule.discountPercentage;
      await checkAndCreateDiscount(bestRule);
    } else {
      bundleState.activeRule = null;
      bundleState.currentDiscountPercent = 0;
    }

    // Update UI
    updateUI();
    updateAllPrices();
    updateBottomBar();

  } catch (error) {
    console.error('Error fetching cart:', error);
    bundleState.currentDiscountPercent = 0;
    updateAllPrices();
  } finally {
    bundleState.cartFetchInFlight = false;
  }
}

// ==================== DISCOUNT FUNCTIONS ====================
async function checkAndCreateDiscount(rule) {
  if (bundleState.isCreatingDiscount || !rule) return;

  if (!rule.discountCode) {
    await createDiscountCode(rule);
  } else {
    bundleState.currentDiscountCode = rule.discountCode;
    bundleState.currentDiscountPercent = rule.discountPercentage;
    await applyDiscountToCart(rule.discountCode, { showToastOnApply: false });
    updateUI();
    updateAllPrices();
  }
}

async function createDiscountCode(rule) {
  if (bundleState.isCreatingDiscount || !rule) return;

  bundleState.isCreatingDiscount = true;
  showLoader('Activating bundle discount...');

  try {
    const collectionId = document.querySelector('.bundle-wrapper')?.dataset.collectionId;
    const APP_URL = 'https://bundle-app-c4km.onrender.com';

    const response = await fetch(`${APP_URL}/api/create-discount`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        bundleId: rule.bundleId,
        ruleIndex: rule.tierIndex || 0,
        shopDomain: 'kretosstechnology.myshopify.com',
        accessToken: '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',
        collectionId: collectionId
      })
    });

    const data = await response.json();
    if (!data.success) throw new Error(data.error || 'Failed to create discount');

    rule.discountCode = data.discountCode;
    bundleState.currentDiscountCode = data.discountCode;

    await applyDiscountToCart(data.discountCode);
    updateUI();
    showToast(`‚úÖ ${rule.discountPercentage}% bundle discount applied!`, 'success');

  } catch (error) {
    console.error('Error creating discount:', error);
    showToast('‚ùå Failed to activate discount', 'error');
  } finally {
    bundleState.isCreatingDiscount = false;
    hideLoader();
  }
}

async function applyDiscountToCart(discountCode, { showToastOnApply = true } = {}) {
  if (!discountCode || bundleState.lastAppliedCode === discountCode) return;
  
  try {
    await fetch('/cart/update.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ discount: discountCode })
    });
    
    bundleState.lastAppliedCode = discountCode;
    savePersistentData();
    
    if (showToastOnApply) showToast('‚úÖ Bundle discount applied to your cart.', 'success');
  } catch (error) {
    console.error('Error applying discount:', error);
  }
}

// ==================== MODAL FUNCTIONS ====================
function openProductModal(productId) {
  const productData = getProductData(productId);
  if (!productData) return;
  
  bundleState.modal.product = productData;
  
  // Get first available variant or first variant
  const firstAvailableVariant = productData.variants.find(v => v.available) || productData.variants[0];
  if (!firstAvailableVariant) {
    showToast('‚ùå This product is out of stock', 'error');
    return;
  }
  
  bundleState.modal.selectedVariantId = firstAvailableVariant.id;
  bundleState.modal.selectedVariant = firstAvailableVariant;
  
  // Reset carousel positions
  bundleState.modal.carouselPosition = 0;
  
  // Set modal content
  document.getElementById('modalTitle').textContent = productData.title;
  document.getElementById('modalProductTitle').textContent = productData.title;
  
  // Set main image
  const mainImage = document.querySelector('#modalMainImage img');
  if (mainImage) {
    mainImage.src = firstAvailableVariant.image || productData.image;
    mainImage.alt = productData.title;
  }
  
  // Render carousel thumbnails
  renderCarousel();
  
  // Render variant boxes
  renderVariantBoxes();
  
  // Update price
  updateModalPrice();
  
  // Update stock status
  updateModalStockStatus();
  
  // Reset quantity
  document.getElementById('modalQtyInput').value = 1;
  
  // Show modal
  document.getElementById('productModal').style.display = 'flex';
  document.body.classList.add('modal-open');
  bundleState.modal.open = true;
  
  // Calculate carousel visible count after modal is displayed
  setTimeout(() => {
    calculateCarouselVisibleCount();
    updateCarouselButtons();
  }, 100);
}

function closeProductModal() {
  document.getElementById('productModal').style.display = 'none';
  document.body.classList.remove('modal-open');
  bundleState.modal.open = false;
  bundleState.modal.product = null;
  bundleState.modal.selectedVariantId = null;
  bundleState.modal.selectedVariant = null;
  bundleState.modal.carouselPosition = 0;
}

// ==================== CAROUSEL FUNCTIONS ====================
function calculateCarouselVisibleCount() {
  // Thumbnails carousel
  const thumbContainer = document.querySelector('.modal-carousel-wrapper');
  if (thumbContainer) {
    const width = thumbContainer.offsetWidth;
    const itemWidth = 92; // 80px + 12px gap
    bundleState.modal.carouselVisibleCount = Math.max(1, Math.floor(width / itemWidth));
  }
}

function renderCarousel() {
  const carousel = document.getElementById('modalCarousel');
  if (!carousel || !bundleState.modal.product) return;
  
  // Only show images for available variants
  const variants = bundleState.modal.product.variants.filter(v => v.available);
  const selectedVariantId = bundleState.modal.selectedVariantId;
  
  // If no available variants have specific images, show at least the featured product image
  const displayItems = variants.length > 0 ? variants : [{...bundleState.modal.product.variants[0], available: false}];
  
  carousel.innerHTML = displayItems.map(variant => {
    const isSelected = selectedVariantId === variant.id;
    return `
      <div class="modal-thumbnail ${isSelected ? 'active' : ''}"
         onclick="selectVariantFromThumbnail('${variant.id}')">
        <img src="${variant.image}" alt="${variant.title}" loading="lazy">
      </div>
    `;
  }).join('');
  
  // Reset transform
  carousel.style.transform = 'translateX(0)';
}

function moveCarousel(direction) {
  const variants = bundleState.modal.product?.variants.filter(v => v.available) || [];
  const displayCount = variants.length;
  const maxPosition = Math.max(0, displayCount - bundleState.modal.carouselVisibleCount);
  
  let newPosition = bundleState.modal.carouselPosition + direction;
  newPosition = Math.max(0, Math.min(newPosition, maxPosition));
  
  bundleState.modal.carouselPosition = newPosition;
  
  const carousel = document.getElementById('modalCarousel');
  if (carousel) {
    const translateX = -newPosition * 92; // 80px width + 12px gap
    carousel.style.transform = `translateX(${translateX}px)`;
  }
  
  updateCarouselButtons();
}

function updateCarouselButtons() {
  const variants = bundleState.modal.product?.variants.filter(v => v.available) || [];
  const displayCount = variants.length;
  const prevBtn = document.querySelector('.carousel-btn.prev');
  const nextBtn = document.querySelector('.carousel-btn.next');
  
  if (prevBtn) {
    prevBtn.disabled = bundleState.modal.carouselPosition === 0;
  }
  
  if (nextBtn) {
    const maxPosition = Math.max(0, displayCount - bundleState.modal.carouselVisibleCount);
    nextBtn.disabled = bundleState.modal.carouselPosition >= maxPosition;
  }
}


function selectVariantFromThumbnail(variantId) {
  const variant = bundleState.modal.product?.variants.find(v => v.id === variantId);
  if (!variant || !variant.available) return;
  
  bundleState.modal.selectedVariantId = variantId;
  bundleState.modal.selectedVariant = variant;
  
  // Update main image
  const mainImage = document.querySelector('#modalMainImage img');
  if (mainImage) mainImage.src = variant.image;
  
  // Update carousel active state
  updateCarouselActiveState();
  
  // Update variant boxes
  renderVariantBoxes();
  
  // Update price
  updateModalPrice();
  
  // Update stock status
  updateModalStockStatus();
}

function updateCarouselActiveState() {
  const thumbnails = document.querySelectorAll('.modal-thumbnail');
  thumbnails.forEach(thumb => {
    thumb.classList.remove('active');
    const onclickAttr = thumb.getAttribute('onclick');
    if (onclickAttr) {
      const variantId = onclickAttr.match(/'([^']+)'/)?.[1];
      if (variantId === bundleState.modal.selectedVariantId) {
        thumb.classList.add('active');
      }
    }
  });
}

// ==================== VARIANT BOXES ====================
function renderVariantBoxes() {
  const container = document.getElementById('modalVariantBoxes');
  if (!bundleState.modal.product) return;
  
  // Only show available variants
  const variants = bundleState.modal.product.variants.filter(v => v.available);
  const selectedVariantId = bundleState.modal.selectedVariantId;
  
  if (variants.length <= 1) {
    document.getElementById('modalVariantsSection').style.display = 'none';
    return;
  }
  
  document.getElementById('modalVariantsSection').style.display = 'block';
  
  container.innerHTML = variants.map(variant => {
    const isSelected = selectedVariantId === variant.id;
    return `
      <div class="modal-variant-box ${isSelected ? 'active' : ''}"
         onclick="selectVariant('${variant.id}')">
        ${variant.title}
      </div>
    `;
  }).join('');
}

function selectVariant(variantId) {
  const variant = bundleState.modal.product?.variants.find(v => v.id === variantId);
  if (!variant || !variant.available) return;
  
  bundleState.modal.selectedVariantId = variantId;
  bundleState.modal.selectedVariant = variant;
  
  // Update main image
  const mainImage = document.querySelector('#modalMainImage img');
  if (mainImage) mainImage.src = variant.image;
  
  // Update carousel active state
  updateCarouselActiveState();
  
  // Update variant boxes
  renderVariantBoxes();
  
  // Update price
  updateModalPrice();
  
  // Update stock status
  updateModalStockStatus();
}

// ==================== MODAL HELPER FUNCTIONS ====================
function updateModalPrice() {
  const priceDisplay = document.getElementById('modalPriceDisplay');
  const variant = bundleState.modal.selectedVariant;
  
  if (!variant) return;
  
  const originalPrice = variant.price;
  const discountPercent = bundleState.currentDiscountPercent;
  
  if (discountPercent > 0) {
    const discountedPrice = originalPrice * (1 - discountPercent / 100);
    priceDisplay.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <span class="modal-price">${formatCurrencyFromCents(discountedPrice)}</span>
        <span class="modal-price-original">${formatCurrencyFromCents(originalPrice)}</span>
      </div>
      <div class="modal-discount-badge">
        Save ${discountPercent}% on this pack!
      </div>
    `;
  } else {
    priceDisplay.innerHTML = `
      <div class="modal-price">${formatCurrencyFromCents(originalPrice)}</div>
    `;
  }
}

function updateModalStockStatus() {
  const stockElement = document.getElementById('modalStock');
  const addBtn = document.getElementById('modalAddBtn');
  const variant = bundleState.modal.selectedVariant;
  
  if (!variant) return;
  
  if (variant.available) {
    stockElement.className = 'modal-inventory-info in-stock';
    stockElement.innerHTML = '<span>‚úì</span> In Stock';
    addBtn.disabled = false;
  } else {
    stockElement.className = 'modal-inventory-info out-of-stock';
    stockElement.innerHTML = '<span>‚úï</span> Out of Stock';
    addBtn.disabled = true;
  }
}

function decreaseModalQty() {
  const input = document.getElementById('modalQtyInput');
  if (input.value > 1) {
    input.value = parseInt(input.value) - 1;
  }
}

function increaseModalQty() {
  const input = document.getElementById('modalQtyInput');
  if (parseInt(input.value) < 10) {
    input.value = parseInt(input.value) + 1;
  }
}

function handleModalQtyInput(e) {
  let value = e.target.value;
  value = value.replace(/[^\d]/g, '');
  
  if (value === '' || parseInt(value) < 1) {
    value = '1';
  }
  
  e.target.value = value;
}

function validateModalQty(e) {
  let value = parseInt(e.target.value);
  if (isNaN(value) || value < 1) {
    value = 1;
  } else if (value > 10) {
    value = 10;
  }
  e.target.value = value;
}

// ==================== ADD TO BUNDLE ====================
async function addToBundle() {
  const variant = bundleState.modal.selectedVariant;
  const quantity = parseInt(document.getElementById('modalQtyInput').value) || 1;
  
  if (!variant || !variant.available) {
    showToast('‚ùå This variant is out of stock.', 'error');
    return;
  }
  
  if (quantity < 1 || quantity > 10) {
    showToast('‚ùå Please enter a valid quantity (1-10).', 'warning');
    return;
  }
  
  try {
    showLoader('Adding to pack...');
    
    // Add to cart using Shopify API
    const response = await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        id: variant.id, 
        quantity: quantity 
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      showToast('‚úÖ Added to bundle!', 'success');
      closeProductModal();
      await updateCartData({ reason: 'modal_add', force: true });
      // Expand review section when adding items
      expandReviewSection();
    } else {
      throw new Error(result.description || 'Failed to add product');
    }
    
  } catch (error) {
    console.error('Add to cart error:', error);
    showToast(`‚ùå ${error.message || 'Failed to add product'}`, 'error');
  } finally {
    hideLoader();
  }
}

// ==================== BOTTOM BAR FUNCTIONS ====================
function updateBottomBar() {
  const bottomBar = document.getElementById('bottomBar');
  const totalItems = bundleState.cartItems;
  const statusBar = document.getElementById('discountStatusBar');
  const btnBadge = document.getElementById('btnCartBadge');
  const checkoutBtnText = document.getElementById('checkoutBtnText');
  const section = document.getElementById('reviewSection');
  
  if (totalItems > 0) {
    bottomBar.classList.add('visible');
    
    // Update Badge
    if (btnBadge) btnBadge.textContent = totalItems;
    
    // Calculate total price and discount info
    const discount = bundleState.activeRule;
    const originalTotal = bundleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const discountedTotal = discount ? originalTotal * (1 - discount.discountPercentage / 100) : originalTotal;
    
    // Update Discount Status Bar
    if (statusBar) {
      if (discount && discount.discountPercentage > 0) {
        statusBar.style.display = 'block';
        statusBar.innerHTML = `üéâ Awesome! You've unlocked ${discount.discountPercentage}% OFF - Saved ${formatCurrencyFromCents(originalTotal - discountedTotal)}`;
      } else {
        statusBar.style.display = 'none';
      }
    }
    
    // Update button text based on expansion state
    const isExpanded = section.classList.contains('expanded');
    if (isExpanded) {
      checkoutBtnText.innerHTML = `Continue to Checkout - ${formatCurrencyFromCents(discountedTotal)}`;
    } else {
      checkoutBtnText.innerHTML = `Review Your Pack - ${formatCurrencyFromCents(discountedTotal)}`;
    }
    
    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) checkoutBtn.disabled = false;
    
    // Render review items
    renderReviewItems();
  } else {
    bottomBar.classList.remove('visible');
    const checkoutBtn = document.getElementById('checkoutBtn');
    if (checkoutBtn) checkoutBtn.disabled = true;
  }
}

function handleBottomBarAction() {
  const section = document.getElementById('reviewSection');
  const isExpanded = section.classList.contains('expanded');
  
  if (isExpanded) {
    // Only proceed to checkout if the section is ALREADY expanded
    proceedToCheckout();
  } else {
    // Otherwise, just open the review section
    toggleReviewSection();
  }
}

function toggleReviewSection() {
  const section = document.getElementById('reviewSection');
  const checkoutBtnText = document.getElementById('checkoutBtnText');
  
  if (bundleState.cartItems === 0) {
    showToast('Your pack is empty. Add some items first!', 'warning');
    return;
  }
  
  const isExpanded = section.classList.contains('expanded');
  
  // Calculate total price for dynamic button text
  const discount = bundleState.activeRule;
  const originalTotal = bundleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const discountedTotal = discount ? originalTotal * (1 - discount.discountPercentage / 100) : originalTotal;
  
  if (isExpanded) {
    section.classList.remove('expanded');
    checkoutBtnText.innerHTML = `Review Your Pack - ${formatCurrencyFromCents(discountedTotal)}`;
  } else {
    section.classList.add('expanded');
    checkoutBtnText.innerHTML = `Continue to Checkout - ${formatCurrencyFromCents(discountedTotal)}`;
  }
}

function expandReviewSection() {
  const section = document.getElementById('reviewSection');
  if (bundleState.cartItems > 0) {
    section.classList.add('expanded');
    updateBottomBar();
  }
}

function renderReviewItems() {
  const container = document.getElementById('reviewItems');
  const discount = bundleState.activeRule;
  
  if (!bundleItems || bundleItems.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:#718096;padding:20px;">Your pack is empty</div>';
    return;
  }
  
  container.innerHTML = bundleItems.map((item, index) => {
    const originalPrice = item.price;
    const itemTotal = originalPrice * item.quantity;
    const discountedPrice = discount ? 
      originalPrice * (1 - discount.discountPercentage / 100) : 
      originalPrice;
    const discountedTotal = discountedPrice * item.quantity;
    
    // Check if item is in stock
    const isInStock = item.available !== false;
    
    return `
      <div class="bundle-review-item" data-index="${index}" data-variant-id="${item.variantId}" data-key="${item.key}">
        <div class="bundle-review-thumb">
          <img src="${item.image}" alt="${item.title}" loading="lazy">
        </div>
        <div class="bundle-review-info">
          <div class="bundle-review-title">${item.title}</div>
          <div class="bundle-review-variant">${item.variantTitle || 'Default'}</div>
          ${!isInStock ? '<div style="color:#dc2626;font-size:11px;font-weight:600;margin-top:2px;">Out of Stock</div>' : ''}
          ${discount && discount.discountPercentage > 0 ? `
            <div class="bundle-review-price original">${formatCurrencyFromCents(itemTotal)}</div>
            <div class="bundle-review-price">${formatCurrencyFromCents(discountedTotal)}</div>
          ` : `
            <div class="bundle-review-price">${formatCurrencyFromCents(itemTotal)}</div>
          `}
        </div>
        <div class="bundle-review-qty">
          <button class="qty-btn-small" onclick="decreaseItemQty(${index})" ${item.quantity <= 1 || !isInStock ? 'disabled' : ''}>-</button>
          <div class="qty-display">${item.quantity}</div>
          <button class="qty-btn-small" onclick="increaseItemQty(${index})" ${!isInStock ? 'disabled' : ''}>+</button>
        </div>
        <button class="remove-btn" onclick="removeItem(${index})" ${!isInStock ? 'style="opacity:0.7"' : ''}>
          <span>üóëÔ∏è</span>
          Remove
        </button>
      </div>
    `;
  }).join('');
}

function calculateTotalSavings() {
  const discount = bundleState.activeRule;
  if (!discount || discount.discountPercentage === 0) return 0;
  
  const originalTotal = bundleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const discountedTotal = originalTotal * (1 - discount.discountPercentage / 100);
  
  return originalTotal - discountedTotal;
}

// ==================== ITEM QUANTITY CONTROLS ====================
async function decreaseItemQty(index) {
  if (index < 0 || index >= bundleItems.length) return;
  
  const item = bundleItems[index];
  if (item.quantity <= 1) {
    await removeItem(index);
    return;
  }
  
  await updateCartItemQty(item.variantId, item.quantity - 1, item.key, index);
}

async function increaseItemQty(index) {
  if (index < 0 || index >= bundleItems.length) return;
  
  const item = bundleItems[index];
  await updateCartItemQty(item.variantId, item.quantity + 1, item.key, index);
}

async function updateCartItemQty(variantId, newQty, lineItemKey, itemIndex) {
  try {
    showLoader('Updating quantity...');
    
    const res = await fetch('/cart/update.js', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        updates: { [String(lineItemKey)]: newQty }
      })
    });
    
    const result = await res.json();
    
    if (!res.ok) {
      throw new Error(result.description || 'Failed to update cart');
    }
    
    await updateCartData({ reason: 'qty_change', force: true });
    
    // Show appropriate message
    if (itemIndex !== undefined) {
      const currentItem = bundleItems[itemIndex];
      if (currentItem && newQty > currentItem.quantity) {
        showToast('‚úÖ Quantity increased', 'success');
      } else if (currentItem && newQty < currentItem.quantity) {
        showToast('‚úÖ Quantity decreased', 'success');
      }
    }
    
  } catch (error) {
    console.error('Cart update error:', error);
    showToast(`‚ùå ${error.message}`, 'error');
  } finally {
    hideLoader();
  }
}

async function removeItem(index) {
  if (index < 0 || index >= bundleItems.length) return;
  
  const item = bundleItems[index];
  
  try {
    showLoader('Removing item...');
    
    const res = await fetch('/cart/update.js', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ 
        updates: { [String(item.key)]: 0 }
      })
    });
    
    if (!res.ok) throw new Error('Cart update failed');
    
    await updateCartData({ reason: 'remove_item', force: true });
    showToast('‚úÖ Item removed from pack.', 'success');
    
  } catch (e) {
    console.error(e);
    showToast('‚ùå Failed to remove item.', 'error');
  } finally {
    hideLoader();
  }
}

// ==================== CHECKOUT ====================
async function proceedToCheckout() {
  if (bundleItems.length === 0) return;
  
  // Directly redirect to checkout with the discount code in the URL
  // This is the fastest and most reliable way in Shopify
  const discountCode = bundleState.currentDiscountCode;
  let checkoutUrl = '/checkout';
  
  if (discountCode) {
    checkoutUrl += `?discount=${encodeURIComponent(discountCode)}`;
  }
  
  window.location.href = checkoutUrl;
}

// ==================== UI UPDATE FUNCTIONS ====================
function updateUI() {
  renderBundleRules();
  updateAllPrices();
}

function updateAllPrices() {
  const discountPercent = bundleState.currentDiscountPercent;
  
  // Update Grid Products
  document.querySelectorAll('.bundle-product').forEach(product => {
    const productId = product.dataset.productId;
    const priceData = bundleState.productPrices[productId];
    if (!priceData) return;
    
    const priceEl = product.querySelector('.price-wrapper');
    if (!priceEl) return;
    
    if (discountPercent > 0) {
      const originalPrice = priceData.original;
      const discountedPrice = originalPrice * (1 - discountPercent / 100);
      
      priceEl.innerHTML = `
        <span class="price-original cut">${formatCurrencyFromCents(originalPrice)}</span>
        <span class="price-discounted">${formatCurrencyFromCents(discountedPrice)}</span>
      `;
      
      priceData.discounted = discountedPrice;
    } else {
      priceEl.innerHTML = `<span class="price-original">${formatCurrencyFromCents(priceData.original)}</span>`;
      priceData.discounted = priceData.original;
    }
  });
  
  // Update Modal Price if open
  if (bundleState.modal.open && bundleState.modal.selectedVariant) {
    updateModalPrice();
  }
}

// ==================== HELPER FUNCTIONS ====================
function getProductData(productId) {
  const productEl = document.querySelector(`#productData [data-product="${productId}"]`);
  if (!productEl) return null;
  
  const variants = Array.from(productEl.querySelectorAll('[data-variants] > div')).map(v => ({
    id: v.getAttribute('data-variant-id'),
    title: v.getAttribute('data-variant-title'),
    price: parseInt(v.getAttribute('data-variant-price')),
    available: v.getAttribute('data-variant-available') === 'true',
    image: v.getAttribute('data-variant-image')
  }));
  
  return {
    id: productId,
    title: productEl.querySelector('[data-title]').getAttribute('data-title'),
    price: parseInt(productEl.querySelector('[data-price]').getAttribute('data-price')),
    available: productEl.querySelector('[data-available]').getAttribute('data-available') === 'true',
    image: productEl.querySelector('[data-image]').getAttribute('data-image'),
    variants: variants
  };
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('bundleToast');
  toast.textContent = message;
  toast.className = `bundle-toast ${type}`;
  toast.classList.add('show');
  
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

function showLoader(text = 'Processing...') {
  const loaderText = document.getElementById('loaderText');
  if (loaderText) {
    loaderText.textContent = text;
  }
  document.getElementById('bundleLoader').style.display = 'flex';
}

function hideLoader() {
  document.getElementById('bundleLoader').style.display = 'none';
}

function formatCurrencyFromCents(cents) {
  if (!cents) return '$0.00';
  const amount = parseFloat(cents) / 100;
  if (typeof Shopify !== 'undefined' && Shopify.formatMoney) {
    return Shopify.formatMoney(cents, window.money_format || '{{ amount }}');
  }
  return '$' + amount.toFixed(2);
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Make functions globally available
window.openProductModal = openProductModal;
window.closeProductModal = closeProductModal;
window.decreaseModalQty = decreaseModalQty;
window.increaseModalQty = increaseModalQty;
window.handleModalQtyInput = handleModalQtyInput;
window.validateModalQty = validateModalQty;
window.addToBundle = addToBundle;
window.selectVariant = selectVariant;
window.selectVariantFromThumbnail = selectVariantFromThumbnail;
window.moveCarousel = moveCarousel;
window.toggleReviewSection = toggleReviewSection;
window.handleBottomBarAction = handleBottomBarAction;
window.decreaseItemQty = decreaseItemQty;
window.increaseItemQty = increaseItemQty;
window.removeItem = removeItem;
window.proceedToCheckout = proceedToCheckout;
</script>

{% else %}
<div class="bundle-wrapper">
  <div class="bundle-header">
    <h1 class="bundle-title">Bundle Collection Not Found</h1>
    <p class="bundle-description">Please select a collection in the theme settings.</p>
  </div>
</div>
{% endif %}

{% schema %}
{
  "name": "Bundle Products",
  "target": "section",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Select collection"
    }
  ]
}
{% endschema %}
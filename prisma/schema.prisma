// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// REQUIRED by Shopify's session storage package
model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             TIMESTAMP?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName           String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires TIMESTAMP?
  
  @@unique([shop])
}

// Your custom Bundle table
model Bundle {
  id                String   @id @default(uuid())
  name              String
  collectionId      String
  collectionTitle   String
  createdAt         TIMESTAMP @default(now())
  updatedAt         TIMESTAMP @updatedAt
  rules             String
  discountCodes     Json?
  shopifyDiscountId String?
}

// This model tracks individual discount code creations
model DiscountCode {
  id             String   @id @default(cuid())
  code           String   @unique
  bundleId       String
  ruleIndex      Int
  customerId     String?
  sessionId      String?
  discountNodeId String
  used           Boolean  @default(false)
  createdAt      TIMESTAMP @default(now())
  expiresAt      TIMESTAMP
  
  // Indexes for faster queries
  @@index([bundleId, ruleIndex])
  @@index([customerId])
  @@index([sessionId])
  @@index([used])
  @@index([createdAt])
  
  // Add a composite index for checking existing discounts
  @@index([bundleId, ruleIndex, customerId, sessionId])
}